#!/usr/bin/env python3

import cgi
import sys
from datetime import datetime, timedelta
import re
from haversine import haversine
from hive import login, get_hub_name, get_id, get_node_names, get_temps, get_current_temps, get_weather, url

print("Content-type:text/html")
print()

headers = login()
if 'authorization' not in headers:
	print("""<html><head><meta http-equiv="refresh" content="0; URL='login.html'" /></head></html>""")
	sys.exit()

hub_name = get_hub_name(headers)
id_ = get_id(headers, hub_name)

if id_ is None:
	print("Could not find a device called "+hub_name+".<br />")
	print("Here are the devices I could find:<br />")
	print(str(get_node_names(headers)))
	sys.exit()

fs = cgi.FieldStorage()

startdate = datetime.now()-timedelta(days=1)
if 'start' in fs:
	start = fs.getvalue('start')
	if start.startswith('20'):
		startyear=int(start[0:4])
		startmonth=int(start[4:6])
		startday=int(start[6:8])
		starthour = startmin = startsec = 0
		if len(start)>8:
			starthour = int(start[8:10])
			if len(start)>10:
				startmin = int(start[10:12])
				if len(start)>12:
					startsec = int(start[12:14])
		startdate = datetime(startyear, startmonth, startday, starthour, startmin, startsec)
	match = re.match(r'-([0-9]+)(year|month|week|day|hour|min|sec)', start, re.I)
	if match:
		if 'year' in match.group(2):
			startdate = datetime.now() - timedelta(days=int(match.group(1))*365)
		if 'month' in match.group(2):
			startdate = datetime.now() - timedelta(days=int(match.group(1))*31)
		if 'week' in match.group(2):
			startdate = datetime.now() - timedelta(weeks=int(match.group(1)))
		if 'day' in match.group(2):
			startdate = datetime.now() - timedelta(days=int(match.group(1)))
		if 'hour' in match.group(2):
			startdate = datetime.now() - timedelta(hours=int(match.group(1)))
		if 'min' in match.group(2):
			startdate = datetime.now() - timedelta(minutes=int(match.group(1)))
		if 'sec' in match.group(2):
			startdate = datetime.now() - timedelta(seconds=int(match.group(1)))


enddate = datetime.now()
if 'end' in fs:
	end = fs.getvalue('end')
	if end.startswith('20'):
		endyear=int(end[0:4])
		endmonth=int(end[4:6])
		endday=int(end[6:8])
		endhour = endmin = endsec = 0
		if len(end)>8:
			endhour = int(end[8:10])
			if len(end)>10:
				endmin = int(end[10:12])
				if len(end)>12:
					endsec = int(end[12:14])
		enddate = datetime(endyear, endmonth, endday, endhour, endmin, endsec)
	match = re.match(r'-([0-9]+)(year|month|week|day|hour|min|sec)', end, re.I)
	if match:
		if 'year' in match.group(2):
			enddate = datetime.now() - timedelta(days=int(match.group(1))*365)
		if 'month' in match.group(2):
			enddate = datetime.now() - timedelta(days=int(match.group(1))*31)
		if 'week' in match.group(2):
			enddate = datetime.now() - timedelta(weeks=int(match.group(1)))
		if 'day' in match.group(2):
			enddate = datetime.now() - timedelta(days=int(match.group(1)))
		if 'hour' in match.group(2):
			enddate = datetime.now() - timedelta(hours=int(match.group(1)))
		if 'min' in match.group(2):
			enddate = datetime.now() - timedelta(minutes=int(match.group(1)))
		if 'sec' in match.group(2):
			enddate = datetime.now() - timedelta(seconds=int(match.group(1)))

temps = get_temps(headers, id_, startdate, enddate)
currentTemp, currentTarget = get_current_temps(headers)
weather = get_weather(startdate, enddate, headers)
if startdate.day == enddate.day:
	xformat="HH:mm:ss"
else:
	xformat="DD-MM-YY HH:mm:ss"


print("""
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>My Hive Temperatures</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
<script>
var pagelink=location.origin+location.pathname;
""")
print("var currentTemp="+str(currentTemp)+";")
print("var currentTargetRaw="+str(currentTarget)+";")
print("""
var currentTarget=currentTargetRaw.toFixed(1)

var dataSets = [];
var dataPoints = [];
var dataPoints2 = [];
var dataPoints3 = [];
""")
print("var tooltipFormat = '"+xformat +"';")

for i in temps:
	print("dataPoints.push({x: "+str(i['date'])+", y: "+str(i['temperature'])+" });")

for i in sorted(weather.keys()):
	print("dataPoints3.push({x: "+str(i)+", y: "+str(weather[i])+" });")


print("dataSets.push({pointStyle:'line', borderColor:'#0000ff', label:'Actual', fill:false, data:dataPoints})")
print("dataSets.push({pointStyle:'line', borderColor:'#00ff00', label:'Weather', fill:false, data:dataPoints3})")
print("var headers="+str(headers).replace("u'","'")+";")
print("var nodesurl='"+url+"/nodes/heating/"+id_+"';")

print("""

var config = {
type: 'line',
data: { datasets: dataSets },
options: {
	title: { display: false },
	legend: {
		display: true,
		position: 'bottom',
		labels: { fontSize: 18, usePointStyle: true }
	},
	scales: {
		xAxes: [{
			type: 'time',
			time: { tooltipFormat: tooltipFormat },
			display: true,
			scaleLabel: { display: false }
		}],
		yAxes: [{
			id: 'left-y-axis',
			display: true,
			position: 'left',
			type: 'linear',
			scaleLabel: {
				display: false
			}
		}]
	}
}
};

window.onload = function() {
var ctx = document.getElementById('myChart').getContext('2d');
var myChart = new Chart(ctx, config);
document.getElementById('currentTempId').innerHTML=currentTemp+'&deg;C'
document.getElementById('currentTargetId').innerHTML=currentTarget+'&deg;C'
document.getElementById('tempToSet').value=currentTarget
document.getElementById('boostTempToSet').value=currentTarget
};


function setTemp() {
temp = document.getElementById("tempToSet").value;
console.log('set '+temp);
var data={'target': temp};
$.ajax({
	url: nodesurl,
	type: 'POST',
	headers: headers,
	data: JSON.stringify(data),
	success: function () {
		console.log('success')
	}
});
location.reload();
}

function boostTemp() {
temp = document.getElementById("boostTempToSet").value;
time = document.getElementById("boostTime").value;
console.log('boost '+temp+' '+time);
var data={'mode': 'BOOST', 'boost': time, 'target': temp}; 
$.ajax({
	url: nodesurl,
	type: 'POST',
	headers: headers,
	data: JSON.stringify(data),
	success: function () {
		console.log('success')
	}
});
location.reload();
}

</script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>

<table border=0 align=center width=70%><tr align=center><th width=25%>Current Temperature</th><th width=25%>Current Setpoint</th><th width=25%>New setpoint</th><th>Boost</th></tr>
<tr align=center><td id='currentTempId' style='padding-top: 0px'>&deg;C</td>
<td id='currentTargetId' style='padding-top: 0px'>&deg;C</td>
<td style='padding-top: 16px'><form onsubmit='setTemp(); return false'><input id='tempToSet' type=text size=3 style='text-align:center;'></input>&deg;C<input type='submit' hidden /></form></td>
<td style='padding-top: 16px'><form onsubmit='boostTemp(); return false'><input id='boostTempToSet' type=text size=3 style='text-align:center;'></input>&deg;C for <input id='boostTime' type=text size=1 value=5 style='text-align:center;'>mins</input><input type='submit' hidden /></form></td>
</tr></table>

<canvas id="myChart" width="800" height="400"></canvas>

<br /><br /><center><form>
<input type='button' onClick='window.location.href=pagelink+"?start=-1hour&end=now";' value='Last 1 hour' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-12hours&end=now";' value='Last 12 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.reload(true);' value='Refresh' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-24hours&end=now";' value='Last 24 hours' style='font-size:20px;height:100px;width:200px'>
<input type='button' onClick='window.location.href=pagelink+"?start=-7days&end=now";' value='Last 7 days' style='font-size:20px;height:100px;width:200px'>

</form></center><br />
<a href='schedule.html'>Schedule View</a>
</body>
</html>
""")
