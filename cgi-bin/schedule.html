#!/usr/bin/python
# -*- coding: utf-8 -*-

from hive import *

headers = login()

print("Content-type:text/html")
print()
print("""
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>My Hive Schedule</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
var headers="""+str(headers).replace("u'","'")+""";
var url = 'https://beekeeper.hivehome.com/1.0'


function getSchedule(hub_name) {
	$.ajax({
		url: url+'/products',
		type: 'GET',
		headers: headers,
		success: function (json) {
			for (device in json) {
				if (json[device]['type'] == hub_name) {
					content = json[device]['state']['schedule'];
					loadJsonIntoForm(content);
				}
			}
		}
	});
}

function loadJsonIntoForm(json) {
	for (day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
		for (num of Array(6).keys()) {
			document.getElementById(day+num).innerHTML = ''
		}
	}
	json_div = document.getElementById("text-val")
	json_div.style.display = "none"
	json_div.innerHTML = JSON.stringify(json);
	for (day in json) {
		for (num in json[day]) {
			el = document.getElementById(day+num);
			if ('target' in json[day][num]['value']) {
				target = JSON.stringify(json[day][num]['value']['target'])+'Â°C';
			} else {
				target = json[day][num]['value']['status'];
			}
			start = JSON.stringify(json[day][num]['start']);
			hours = ('00'+Math.floor(start/60)).slice(-2);
			mins = ('00'+start%60).slice(-2);
			el.innerHTML = '&nbsp;'+target+' @ '+hours+':'+mins+'&nbsp;';
		}
	}
}

function getProducts() {
	return $.ajax({
		url: url+'/products',
		type: 'GET',
		async: false,
		headers: headers,
	})
}


function sendSchedule(hub_name) {
	var schedule = JSON.parse(document.getElementById("text-val").innerHTML);
	var products = getProducts();
	var json = JSON.parse(products.responseText);
	var id = ''
	for (device in json) {
		if (json[device]['type'] == hub_name) {
			id = json[device]['id'];	
		}
	}
	console.log(id);
	var data = JSON.stringify({'schedule': schedule});
	console.log(data);
	$.ajax({
		url: url+'/nodes/heating/'+id,
		type: 'POST',
		headers: headers,
		data: data,
		success: function (json) {
			console.log('success')
		},
		error: function () {
			console.log('error')
		}
	})
}


function download() {
	var date = new Date().toISOString().substr(0, 16);
	var text = document.getElementById("text-val").innerHTML;
	var filename = "hive_schedule_"+date+".txt";
	var element = document.createElement('a');
	element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	element.setAttribute('download', filename);
	element.style.display = 'none';
	document.body.appendChild(element);
	element.click();
	document.body.removeChild(element);
}

function openfile(e) {
	console.log('openfile');
	console.log(e);
	var file = e[0]; 
	var reader = new FileReader();
	reader.readAsText(file,'UTF-8');

	reader.onload = readerEvent => {
		var content = JSON.parse(readerEvent.target.result)
		loadJsonIntoForm(content);
	}
}

</script>
</head><body>
<button height=10 onclick='getSchedule("heating");'>Get Heating Schedule</button>
<button height=10 onclick='getSchedule("hotwater");'>Get Hot Water Schedule</button>
<br /><br />
<div id="text-val"></div><br/>
<table border=0>
<tr><td>Monday</td><td><div id="monday0"></div></td><td><div id="monday1"></td><td><div id="monday2"></td><td><div id="monday3"></td><td><div id="monday4"></td><td><div id="monday5"></td></tr>
<tr><td>Tuesday</td><td><div id="tuesday0"></div></td><td><div id="tuesday1"></td><td><div id="tuesday2"></td><td><div id="tuesday3"></td><td><div id="tuesday4"></td><td><div id="tuesday5"></td></tr>
<tr><td>Wednesday</td><td><div id="wednesday0"></div></td><td><div id="wednesday1"></td><td><div id="wednesday2"></td><td><div id="wednesday3"></td><td><div id="wednesday4"></td><td><div id="wednesday5"></td></tr>
<tr><td>Thursday</td><td><div id="thursday0"></div></td><td><div id="thursday1"></td><td><div id="thursday2"></td><td><div id="thursday3"></td><td><div id="thursday4"></td><td><div id="thursday5"></td></tr>
<tr><td>Friday</td><td><div id="friday0"></div></td><td><div id="friday1"></td><td><div id="friday2"></td><td><div id="friday3"></td><td><div id="friday4"></td><td><div id="friday5"></td></tr>
<tr><td>Saturday</td><td><div id="saturday0"></div></td><td><div id="saturday1"></td><td><div id="saturday2"></td><td><div id="saturday3"></td><td><div id="saturday4"></td><td><div id="saturday5"></td></tr>
<tr><td>Sunday</td><td><div id="sunday0"></div></td><td><div id="sunday1"></td><td><div id="sunday2"></td><td><div id="sunday3"></td><td><div id="sunday4"></td><td><div id="sunday5"></td></tr>
</table><br /><br />
<input type="button" id="dwn-btn" value="Save schedule to file" onclick='download();'/>

<button onclick="document.getElementById('file-input').click();">Load schedule from file</button>
<input id="file-input" type="file" name="name" style="display: none;" onchange='openfile(this.files);'/>
<br /><br />
<button height=10 onclick='sendSchedule("heating");'>Send Heating Schedule</button>
<button height=10 onclick='sendSchedule("hotwater");'>Send Hot Water Schedule</button>

</html>
""")
