<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Hive Login</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
var baseurl = 'https://beekeeper.hivehome.com/1.0';

function setCookie(cname, cvalue, exdays) {
	var d = new Date();
	d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
	var expires = "expires="+d.toUTCString();
	document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

function getCookie(cname) {
	var name = cname + "=";
	var ca = document.cookie.split(';');
	for(var i = 0; i < ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		}
	}
	return "";
}


function login() {
	username = document.getElementById("username").value;
	password = document.getElementById("password").value;
	headers = {"Content-Type": "application/json", "Accept": "application/json"}
	payload = {"username": username, "password": password}
	$.ajax({
		url: baseurl + '/global/login',
		type: 'POST',
		headers: headers,
		data: JSON.stringify(payload),
		dataType: 'json',
		success: function(json) {
			console.log(json);
			if ('token' in json) {
				console.log('success');
				setCookie('token', json['token'], 365)
				document.getElementById("loginstate").innerHTML = 'You are now logged in.';
				document.getElementById("mainbody").innerHTML = "<a href='schedule.html'>Schedule view</a><br /><a href='hive.py'>History view</a><br />";
			}
		},
		error: function(json) {
			console.log('Error');
			console.log(json);
		}
	})
}

function checklogin() {
	var token = getCookie('token');
	if (token != "") {
		data = JSON.stringify({"homes": false, "products": false, "devices": false, "actions": false, "token": token});
		$.ajax({
			url: baseurl + '/auth/admin-login',
			type: 'POST',
			contentType: 'application/json',
			data: data,
			dataType: 'json',
			success: function(json) {
				console.log('success');
				console.log(json);
				if ('user' in json){
					document.getElementById("loginstate").innerHTML = "You are now logged in.";
					document.getElementById("mainbody").innerHTML = "<a href='schedule.html'>Schedule view</a><br /><a href='hive.py'>History view</a><br />"
				}
			},
			error: function(json) {
				console.log('Token expired');
			}
		})
	}
}

</script>
<style>
.l1 {
	width: 100px;
	display: inline-block;
}
</style>
</head>
<body onload="checklogin()">

<div id="loginstate">You are not logged in.</div><br /><br />
<div id="mainbody"><label class="l1" for="username">Username: </label><input id="username"><br />
<label class="l1" for="password">Password: </label><input type="password" id="password"><br /><br />
<input type="submit" value="Submit" onclick="return login();"></div>
</body></html>
